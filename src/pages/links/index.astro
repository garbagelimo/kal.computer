---
import BaseLayout from '../../layouts/BaseLayout.astro';
import EntryCard from '../../components/EntryCard.astro';
import { getCollection } from 'astro:content';

const links = await getCollection('links');
const grouped = links.reduce((acc, link) => {
  const key = link.data.category || 'misc';
  acc[key] = acc[key] ?? [];
  acc[key].push(link);
  return acc;
}, {});

const categories = Object.keys(grouped).sort((a, b) => a.localeCompare(b));
const toCategoryId = (category) =>
  category.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
const toCategoryHref = (category) => `/links/${encodeURIComponent(category)}`;
---

<BaseLayout title="Links" description="A board of links worth keeping.">
  <section class="panel panel--accent">
    <h1>Link board</h1>
    <p class="tagline">Small notes on things I keep returning to.</p>
    <div class="pill-row">
      {categories.map((category) => (
        <a class="pill" href={`#${toCategoryId(category)}`}>
          {category}
        </a>
      ))}
    </div>
  </section>

  {categories.map((category) => (
    <section class="panel" style="margin-top: 24px;" id={toCategoryId(category)}>
      <div class="section-header">
        <h2 class="link-category">
          <a href={toCategoryHref(category)}>{category}</a>
        </h2>
        <div class="link-category-meta">
          <span class="link-count">{grouped[category].length} entries</span>
          <a href={toCategoryHref(category)}>view all</a>
        </div>
      </div>
      <div class="grid">
        {grouped[category].map((link) => (
          <EntryCard
            title={link.data.title}
            href={link.data.url}
            external
            eyebrow={link.data.pubDate
              ? link.data.pubDate.toLocaleDateString('en-US', {
                  year: 'numeric',
                  month: 'short',
                  day: 'numeric',
                })
              : 'undated'}
            summary={link.data.description}
            tags={[`#${link.data.category}`]}
          />
        ))}
      </div>
    </section>
  ))}
</BaseLayout>
