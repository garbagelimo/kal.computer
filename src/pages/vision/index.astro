---
import BaseLayout from '../../layouts/BaseLayout.astro';

const images = Object.values(
  import.meta.glob('../../assets/vision/*.{png,jpg,jpeg,webp,avif}', {
    eager: true,
    as: 'url',
  })
).sort((a, b) => a.localeCompare(b));
---

<BaseLayout title="Vision" description="A visual dump of references and experiments.">
  <section class="panel panel--accent panel--tight">
    <div class="section-header">
      <h1>vision boarrd</h1>
      <button class="vision-shuffle" type="button">shuffle</button>
    </div>
  </section>

  <section class="panel panel--raw vision-grid" id="vision-grid" style="margin-top: 16px;">
    {images.length === 0 ? (
      <p class="tagline">No images yet. Add files in src/assets/vision.</p>
    ) : (
      images.map((src) => (
        <button class="vision-item" type="button" data-full={src} aria-label="Open image">
          <img src={src} alt="" loading="lazy" />
        </button>
      ))
    )}
  </section>

  <div class="vision-modal" id="vision-modal" aria-hidden="true" role="dialog" aria-label="Image preview">
    <div class="vision-modal__content">
      <button class="vision-modal__close" type="button" aria-label="Close image preview">âœ•</button>
      <img id="vision-modal-image" alt="" />
    </div>
  </div>
</BaseLayout>

<script is:inline>
  const shuffle = (items) => {
    for (let i = items.length - 1; i > 0; i -= 1) {
      const j = Math.floor(Math.random() * (i + 1));
      [items[i], items[j]] = [items[j], items[i]];
    }
    return items;
  };

  const shuffleButton = document.querySelector('.vision-shuffle');
  const grid = document.getElementById('vision-grid');

  if (shuffleButton && grid) {
    shuffleButton.addEventListener('click', () => {
      const items = Array.from(grid.querySelectorAll('.vision-item'));
      shuffle(items).forEach((item) => grid.appendChild(item));
    });
  }

  const modal = document.getElementById('vision-modal');
  const modalImage = document.getElementById('vision-modal-image');
  const closeButton = modal?.querySelector('.vision-modal__close');
  const openModal = (src) => {
    if (!modal || !modalImage) return;
    modalImage.src = src;
    modal.classList.add('is-open');
    modal.setAttribute('aria-hidden', 'false');
    document.body.style.overflow = 'hidden';
  };
  const closeModal = () => {
    if (!modal || !modalImage) return;
    modal.classList.remove('is-open');
    modal.setAttribute('aria-hidden', 'true');
    modalImage.src = '';
    document.body.style.overflow = '';
  };
  document.querySelectorAll('.vision-item').forEach((button) => {
    button.addEventListener('click', () => {
      const src = button.getAttribute('data-full');
      if (src) openModal(src);
    });
  });
  modal?.addEventListener('click', (event) => {
    if (event.target === modal) closeModal();
  });
  closeButton?.addEventListener('click', closeModal);
  document.addEventListener('keydown', (event) => {
    if (event.key === 'Escape' && modal?.classList.contains('is-open')) {
      closeModal();
    }
  });
</script>
